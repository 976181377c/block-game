System.register("chunks:///_virtual/GameManager.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(o){var e,t,r,i,n,a,l,s,c,d,h,g,u,f,p,v,k;return{setters:[function(o){e=o.applyDecoratedDescriptor,t=o.inheritsLoose,r=o.createForOfIteratorHelperLoose,i=o.initializerDefineProperty,n=o.assertThisInitialized},function(o){a=o.cclegacy,l=o._decorator,s=o.Color,c=o.Node,d=o.Prefab,h=o.Label,g=o.UITransform,u=o.instantiate,f=o.Sprite,p=o.v3,v=o.v2,k=o.Component}],execute:function(){var b,B,C,m,w,P,y,T,S,N,M,G,A;a._RF.push({},"052feY+bYdKWIAX02XekNqA","GameManager",void 0);var O=l.ccclass,L=l.property,z=50,D=.7,E=[{shape:[[1,1,1]],color:new s(0,255,255)},{shape:[[1],[1],[1]],color:new s(0,255,255)},{shape:[[1,1],[1,1]],color:new s(255,255,0)},{shape:[[0,1,0],[1,1,1]],color:new s(128,0,128)},{shape:[[1,0,0],[1,1,1]],color:new s(0,0,255)},{shape:[[0,0,1],[1,1,1]],color:new s(255,165,0)},{shape:[[0,1,1],[1,1,0]],color:new s(0,255,0)},{shape:[[1,1,0],[0,1,1]],color:new s(255,0,0)},{shape:[[1]],color:new s(200,200,200)},{shape:[[1,1]],color:new s(150,150,255)}];o("default",(b=O("GameManager"),B=L(c),C=L(c),m=L(d),w=L(h),P=L(c),b((S=e((T=function(o){function e(){for(var e,t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];return e=o.call.apply(o,[this].concat(r))||this,i(e,"boardNode",S,n(e)),i(e,"blockSpawnArea",N,n(e)),i(e,"blockCellPrefab",M,n(e)),i(e,"scoreLabel",G,n(e)),i(e,"gameOverNode",A,n(e)),e.boardModel=[],e.predictionNode=null,e.availableBlocks=[],e.draggedBlock=null,e.score=0,e}t(e,o);var a=e.prototype;return a.onLoad=function(){this.initGame(),this.addInputListeners()},a.initGame=function(){this.gameOverNode.active=!1,this.boardModel=Array(8).fill(0).map((function(){return Array(8).fill(null)})),this.drawGridBackground(),this.predictionNode=new c("Prediction"),this.boardNode.addChild(this.predictionNode),this.updateScore(0),this.spawnNewBlocks()},a.drawGridBackground=function(){this.boardNode.getComponent(g).setContentSize(400,400);for(var o=0;o<8;o++)for(var e=0;e<8;e++){var t=u(this.blockCellPrefab);t.getComponent(g).setContentSize(48,48),t.getComponent(f).color=new s(50,50,50,150),this.boardNode.addChild(t),t.setPosition(this.convertGridToCenterPosition(e,o))}},a.spawnNewBlocks=function(){this.availableBlocks.forEach((function(o){return o.destroy()})),this.availableBlocks=[];for(var o=this.blockSpawnArea.getComponent(g).width/4,e=0;e<3;e++){var t=p(o*(e-1),0,0);this.refillBlock(t)}},a.createBlockNode=function(o,e){void 0===e&&(e=255);var t=new c;t.shapeData=o.shape,t.colorData=o.color,t.addComponent(g);for(var r=o.shape,i=r[0].length,n=r.length,a=0;a<n;a++)for(var l=0;l<i;l++)if(1===r[a][l]){var d=u(this.blockCellPrefab);d.getComponent(f).color=new s(o.color.r,o.color.g,o.color.b,e),d.getComponent(g).setContentSize(z,z),t.addChild(d),d.setPosition((l-(i-1)/2)*z,-(a-(n-1)/2)*z)}return t},a.addInputListeners=function(){this.node.on(c.EventType.TOUCH_START,this.onTouchStart,this),this.node.on(c.EventType.TOUCH_MOVE,this.onTouchMove,this),this.node.on(c.EventType.TOUCH_END,this.onTouchEnd,this),this.node.on(c.EventType.TOUCH_CANCEL,this.onTouchEnd,this)},a.onTouchStart=function(o){if(!this.draggedBlock)for(var e,t=r(this.availableBlocks);!(e=t()).done;){var i=e.value;if(i.getComponent(g).getBoundingBoxToWorld().contains(o.getUILocation())){this.draggedBlock=i;var n=this.draggedBlock.parent.getComponent(g).convertToWorldSpaceAR(this.draggedBlock.position);this.draggedBlock.parent=this.node,this.draggedBlock.position=this.node.getComponent(g).convertToNodeSpaceAR(n),this.draggedBlock.setScale(p(1,1,1)),this.draggedBlock.setSiblingIndex(this.node.children.length-1);break}}},a.onTouchMove=function(o){if(this.draggedBlock){var e=o.getUIDelta(),t=this.draggedBlock.getPosition();this.draggedBlock.setPosition(t.x+e.x,t.y+e.y,t.z),this.updatePrediction()}},a.onTouchEnd=function(o){if(this.draggedBlock){this.predictionNode.removeAllChildren();var e=this.convertWorldToGrid(this.draggedBlock.worldPosition),t=this.getStartGrid(this.draggedBlock,e);if(this.canPlaceBlock(this.draggedBlock,t)){this.placeBlock(this.draggedBlock,t);var r=this.draggedBlock.originalPosition.clone(),i=this.availableBlocks.indexOf(this.draggedBlock);i>-1&&this.availableBlocks.splice(i,1),this.draggedBlock.destroy(),this.draggedBlock=null,this.refillBlock(r),this.checkForClearLines(),this.isGameOver()&&this.showGameOver()}else this.draggedBlock.parent=this.draggedBlock.originalParent,this.draggedBlock.position=this.draggedBlock.originalPosition,this.draggedBlock.setScale(p(D,D,1)),this.draggedBlock=null}},a.refillBlock=function(o){var e=E[Math.floor(Math.random()*E.length)],t=this.createBlockNode(e);this.blockSpawnArea.addChild(t),t.setPosition(o),t.setScale(p(D,D,1)),t.originalPosition=t.position.clone(),t.originalParent=t.parent,this.availableBlocks.push(t)},a.updatePrediction=function(){if(this.predictionNode.removeAllChildren(),this.draggedBlock){var o=this.convertWorldToGrid(this.draggedBlock.worldPosition),e=this.getStartGrid(this.draggedBlock,o);if(this.canPlaceBlock(this.draggedBlock,e))for(var t=this.draggedBlock.shapeData,r=this.draggedBlock.colorData,i=0;i<t.length;i++)for(var n=0;n<t[i].length;n++)if(1===t[i][n]){var a=e.x+n,l=e.y-i,c=u(this.blockCellPrefab);c.getComponent(f).color=new s(r.r,r.g,r.b,100),c.getComponent(g).setContentSize(z,z),this.predictionNode.addChild(c),c.setPosition(this.convertGridToCenterPosition(a,l))}}},a.canPlaceBlock=function(o,e){for(var t=o.shapeData,r=0;r<t.length;r++)for(var i=0;i<t[r].length;i++)if(1===t[r][i]){var n=e.x+i,a=e.y-r;if(n<0||n>=8||a<0||a>=8)return!1;if(this.boardModel[a][n])return!1}return!0},a.placeBlock=function(o,e){for(var t=o.shapeData,r=o.colorData,i=0,n=0;n<t.length;n++)for(var a=0;a<t[n].length;a++)if(1===t[n][a]){var l=e.x+a,s=e.y-n,c=u(this.blockCellPrefab);c.getComponent(f).color=r,c.getComponent(g).setContentSize(z,z),this.boardNode.addChild(c),c.setPosition(this.convertGridToCenterPosition(l,s)),this.boardModel[s][l]=c,i++}this.updateScore(this.score+i)},a.checkForClearLines=function(){for(var o=this,e=[],t=[],r=0;r<8;r++)this.boardModel[r].every((function(o){return null!==o}))&&e.push(r);for(var i=0;i<8;i++){for(var n=!0,a=0;a<8;a++)if(null===this.boardModel[a][i]){n=!1;break}n&&t.push(i)}var l=e.length+t.length;l>0&&(e.forEach((function(e){for(var t=0;t<8;t++)o.boardModel[e][t]&&(o.boardModel[e][t].destroy(),o.boardModel[e][t]=null)})),t.forEach((function(e){for(var t=0;t<8;t++)o.boardModel[t][e]&&(o.boardModel[t][e].destroy(),o.boardModel[t][e]=null)})),this.updateScore(this.score+8*l*2))},a.isGameOver=function(){for(var o,e=r(this.availableBlocks);!(o=e()).done;)for(var t=o.value,i=0;i<8;i++)for(var n=0;n<8;n++)if(this.canPlaceBlock(t,v(n,i)))return console.log(n,i,t),!1;return!0},a.showGameOver=function(){this.gameOverNode.active=!0},a.updateScore=function(o){this.score=o,this.scoreLabel.string="分数: "+this.score},a.getStartGrid=function(o,e){var t=o.shapeData,r=t[0].length,i=t.length,n=e.x-Math.floor((r-1)/2),a=e.y+Math.floor((i-1)/2);return v(n,a)},a.convertWorldToGrid=function(o){var e=this.boardNode.getComponent(g).convertToNodeSpaceAR(o),t=Math.floor(e.x/z),r=Math.floor(e.y/z);return v(t,r)},a.convertGridToCenterPosition=function(o,e){return p(o*z+25,e*z+25,0)},e}(k)).prototype,"boardNode",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=e(T.prototype,"blockSpawnArea",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=e(T.prototype,"blockCellPrefab",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G=e(T.prototype,"scoreLabel",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=e(T.prototype,"gameOverNode",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y=T))||y));a._RF.pop()}}}));

System.register("chunks:///_virtual/main",["./GameManager.ts"],(function(){return{setters:[null],execute:function(){}}}));

(function(r) {
  r('virtual:///prerequisite-imports/main', 'chunks:///_virtual/main'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});